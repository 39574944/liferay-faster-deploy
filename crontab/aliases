#!/bin/bash

if [ "" == "$(which conda 2>/dev/null)" ]; then
	PATH="$HOME/miniconda3/bin:$PATH"
fi

pushd $(dirname "${BASH_SOURCE[0]}") > /dev/null
SCRIPT_FOLDER=$(pwd -P)
popd > /dev/null

if [ "" == "$BUILD_FOLDER_PREFIX" ]; then
	BUILD_FOLDER_PREFIX=$HOME
fi

build() {
	cd $HOME
	rm -f nohup.out
	nohup "$SCRIPT_FOLDER/cronbuild" clean &
	cd -
}

cr() {
	CATALINA_HOME=

	local BUILD_NAME=$(ls /var/www/html/builds/branches | grep "^${1}-[0-9]*.tar.gz" | sort | tail -1)

	if [ "" != "$BUILD_NAME" ]; then
		local TIMESTAMP=$(echo "$BUILD_NAME" | cut -d'-' -f 2 | cut -d'.' -f 1)

		if [ -d "$BUILD_FOLDER_PREFIX/$1/$TIMESTAMP" ]; then
			mkdir -p $BUILD_FOLDER_PREFIX/$1/$TIMESTAMP
			tar -zxf /var/www/html/builds/branches/$BUILD_NAME -C $BUILD_FOLDER_PREFIX/$1/$TIMESTAMP/
		fi

		CATALINA_HOME=$(find $BUILD_FOLDER_PREFIX/$1/$TIMESTAMP -type d -name 'tomcat*' | sort -u | tail -1)
	fi

	if [ "" == "$CATALINA_HOME" ]; then
		echo "Failed to find build for $1"
		return 1
	fi

	if [ ! -d "$CATALINA_HOME/bin" ]; then
		return 1
	fi

	PORT=$(grep -o '"[0-9]*80"' $CATALINA_HOME/conf/server.xml | cut -d'"' -f 2 | sort -u)
	PIDS=$(lsof -b -a -i :$PORT -t -c java)

	if [ "" != "$PIDS" ]; then
		RUNNING_CATALINA_HOME=$(ps --no-headers $PIDS | grep -o "catalina.base=[^ ]*" | cut -d '=' -f 2)

		if [ "$CATALINA_HOME" == "$RUNNING_CATALINA_HOME" ]; then
			echo "$1 is already running"
			return 0
		else
			echo "$RUNNING_CATALINA_HOME is already running on port $PORT"
			return 1
		fi
	fi

	echo "Starting latest build of $1"

	$CATALINA_HOME/bin/startup.sh
}

cs() {
	cr $@
}

cx() {
	if [ "" == "$1" ]; then
		echo "Please specify which Tomcat process to kill"
		return 1
	fi

	if [ "all" == "$1" ]; then
		if [ "" != "$(ps -ef | grep catalina.base | grep -v grep | awk '{ print $2 }')" ]; then
			ps -ef | grep catalina.base | grep -v grep | awk '{ print $2 }' | xargs kill -9
		fi

		return 0
	fi

	if [ -d $BUILD_FOLDER_PREFIX/$1 ]; then
		BUILD_ID=$(ls -1 $BUILD_FOLDER_PREFIX/$1 | grep -vF '.log' | sort | tail -1)
		CATALINA_HOME=$(find $BUILD_FOLDER_PREFIX/$1 -type d -name 'tomcat*')
	else
		echo "Unable to identify which Tomcat to shutdown"
		return 0
	fi

	ps -ef | grep $CATALINA_HOME | grep -v grep | awk '{ print $2 }' | xargs kill -9
}

ct() {
	if [ -d $HOME/$1 ]; then
		echo "Tailing logs for latest build of $1"
		BUILD_ID=$(ls -1 $HOME/$1 | sort | tail -1)
		/usr/bin/tail -f $HOME/$1/$BUILD_ID/tomcat-*/logs/catalina.out
	elif [ -d $BUILD_FOLDER_PREFIX/$1 ]; then
		echo "Tailing logs for build of pull request $1"
		/usr/bin/tail -f $BUILD_FOLDER_PREFIX/$1/tomcat-*/logs/catalina.out
	fi
}