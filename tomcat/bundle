#!/bin/bash

if [ "" == "${CONTAINER_NAME}" ]; then
	if [[ $(basename "$PWD") =~ ^[A-Z]*-[0-9]*$ ]]; then
		CONTAINER_NAME=$(basename "$PWD")
	else
		CONTAINER_NAME='test'
	fi
fi

docker stop ${CONTAINER_NAME} 1> /dev/null 2> /dev/null
docker rm -v ${CONTAINER_NAME} 1> /dev/null 2> /dev/null

if [ "$PWD" != "$HOME" ] && [ "" == "${LIFERAY_HOME_MOUNT}" ]; then
	if [ -f portal-ext.properties ]; then
		LIFERAY_HOME_MOUNT="-v ${PWD}:/build"
	elif [ -d bundles ]; then
		LIFERAY_HOME_MOUNT="-v ${PWD}/bundles:/build"
	elif [ "" == "$1" ] && [ -f app.server.$USER.properties ]; then
		. $(dirname $(dirname ${BASH_SOURCE[0]}))/appserverprops
		LIFERAY_HOME_MOUNT="-v ${LIFERAY_HOME}:/build"
	fi
fi

if [ ! -d ${HOME}/.liferay/release ]; then
	mkdir -p ${HOME}/.liferay/release
fi

LIFERAY_RELEASE_MOUNT="-v ${HOME}/.liferay/release:/release"

if [ "" == "${IMAGE_NAME}" ]; then
	if [ "" != "$2" ]; then
		IMAGE_NAME="mcd-nightly-$2"
	elif [[ $1 == portal-* ]] || [[ $1 == *-6210 ]] || [[ $1 == *-6210.zip ]]; then
		IMAGE_NAME='mcd-nightly-jdk7'
	else
		IMAGE_NAME='mcd-nightly-jdk8'
	fi
fi

echo "Using Docker image ${IMAGE_NAME}"

GLOBAL_BIND="$(echo 8009 8080 8443 | tr ' ' '\n' | awk '{ print  "--publish " $1 ":" $1 }' | xargs)"
LOCAL_BIND="$(echo 8000 11311 | tr ' ' '\n' | awk '{ print  "--publish 127.0.0.1:" $1 ":" $1 }' | xargs)"
EXPOSE_ONLY="$(echo 7800 7801 | tr ' ' '\n' | awk '{ print  "--expose " $1 }' | xargs)"

docker run ${GLOBAL_BIND} ${LOCAL_BIND} ${EXPOSE_ONLY} \
	${LIFERAY_HOME_MOUNT} ${LIFERAY_RELEASE_MOUNT} \
	-e LIFERAY_PASSWORD=${LIFERAY_PASSWORD} \
	--name ${CONTAINER_NAME} ${IMAGE_NAME} $1