#!/bin/bash

docker stop test 1> /dev/null 2> /dev/null
docker rm -v test 1> /dev/null 2> /dev/null

if [ "$PWD" != "$HOME" ] && [ "" == "${LIFERAY_HOME_MOUNT}" ]; then
	if [ -f portal-ext.properties ]; then
		LIFERAY_HOME_MOUNT="-v ${PWD}:/build"
	elif [ -d drivers ]; then
		LIFERAY_HOME_MOUNT="-v ${PWD}:/build"
	elif [ -d patches ]; then
		LIFERAY_HOME_MOUNT="-v ${PWD}:/build"
	elif [ -d bundles ]; then
		LIFERAY_HOME_MOUNT="-v ${PWD}/bundles:/build"
	elif [ "" == "$1" ] && [ -f app.server.$USER.properties ]; then
		. $(dirname $(dirname ${BASH_SOURCE[0]}))/appserverprops
		LIFERAY_HOME_MOUNT="-v ${LIFERAY_HOME}:/build"
	fi
fi

if [ ! -d ${HOME}/.liferay/release ]; then
	mkdir -p ${HOME}/.liferay/release
fi

LIFERAY_RELEASE_MOUNT="-v ${HOME}/.liferay/release:/release"

if [ "" == "${IMAGE_NAME}" ]; then
	if [ "" != "$2" ]; then
		IMAGE_NAME="mcd-nightly-$2"
	elif [[ $1 == portal-* ]] || [[ $1 == *-6210 ]] || [[ $1 == *-6210.zip ]]; then
		IMAGE_NAME='mcd-nightly-jdk7'
	else
		IMAGE_NAME='mcd-nightly-jdk8'
	fi
fi

echo "Using Docker image ${IMAGE_NAME}"

docker run -p 8080:8080 --name test ${LIFERAY_HOME_MOUNT} ${LIFERAY_RELEASE_MOUNT} -e LIFERAY_PASSWORD=${LIFERAY_PASSWORD} ${IMAGE_NAME} $1