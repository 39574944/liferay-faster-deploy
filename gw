#!/bin/bash

checksnapshots() {
	. $(dirname "${BASH_SOURCE[0]}")/checksnapshots
}

findgradle() {
	echo 'Locating gradlew binary'

	if [ -e $GRADLE_HOME/gradlew ]; then
		return 0
	fi

	GRADLE_HOME=$PWD

	while [ ! -e $GRADLE_HOME/gradlew ] && [ "/" != "$GRADLE_HOME" ]; do
		GRADLE_HOME=$(dirname $GRADLE_HOME)
	done

	if [ -e $GRADLE_HOME/gradlew ]; then
		if [[ 0 -ne $(egrep -o $'\r\n'\$ "$GRADLE_HOME/gradlew" | wc -c ) ]]; then
			perl -pi -e 's/\r\n|\n|\r/\n/g' "$GRADLE_HOME/gradlew"
		fi

		chmod u+x $GRADLE_HOME/gradlew

		return 0
	fi

	echo 'Unable to find the gradlew binary'

	if [ "" != "$(which gradle)" ]; then
		echo "Falling back to gradle on the path: $(which gradle)"
		return 0
	fi

	return 1
}

fixgradle() {
	echo 'Checking for common Gradle problems'

	# make sure our dependencies are up to date

	if [ "" != "$GIT_ROOT" ] && [ -f "$GIT_ROOT/build.xml" ] && [ -e $GIT_ROOT/../liferay-binaries-cache-2017 ] && [ "" != "$(grep -F update-binaries-cache "$GIT_ROOT/build.xml")" ]; then
		pushd "$GIT_ROOT" > /dev/null
		ant update-binaries-cache
		popd > /dev/null
	fi

	# undo any past deletions of settings.gradle

	if [ "" != "$GIT_ROOT" ] && [ "" != "$(git ls-files -v | grep '^h ' | cut -d' ' -f 2 | grep -F 'settings.gradle')" ]; then
		git ls-files -v | grep '^h ' | cut -d' ' -f 2 | grep -F 'settings.gradle' | xargs git checkout
	fi

	# a settings.gradle in the parent folder can mess us up, if we're in
	# portal source (which has a .gitrepo file)

	if [ -f ../settings.gradle ] && [ -f ../.gitrepo ]; then
		rm ../settings.gradle
		git update-index --assume-unchanged ../settings.gradle
	fi

	# if you appear to be building to a Liferay downloaded bundle rather
	# than a built bundle, tell the user to use the override folder

	if [ "" != "$LIFERAY_HOME" ] && [ -d "$LIFERAY_HOME/osgi/marketplace" ] && [[ 0 -ne $(ls -1 $LIFERAY_HOME/osgi/marketplace | grep -F .lpkg | grep -c '^') ]]; then
		local OVERRIDE=$LIFERAY_HOME/osgi/marketplace/override

		if [ "" == "$(grep -F "$OVERRIDE" build.gradle)" ]; then
			echo "If you are absolutely sure you want to deploy to a release bundle with .lpkg files"
			echo "(not recommended, because this may require a server restart after every deploy)"
			echo "please add the following to build.gradle:"
			echo -e "\n\njar.archiveName = \"$JAR_NAME\"\n\nliferay {\n\tdeployDir = \"$OVERRIDE\"\n}"
			return 0
		fi
	fi

	# if we have a "default" dependency, make sure we have the snapshot in the .m2 cache

	if [ "" != "$GIT_ROOT" ] && [ "" != "$(grep -F '"com.liferay.portal"' build.gradle | grep -F '"default"' | grep -o 'name: "[^"]*"' | cut -d'"' -f 2)" ]; then
		checksnapshots
	fi

	# if we are missing util-taglib.jar, some Gradle tasks will fail

	local TOMCAT_VERSION=

	if [ -f $GIT_ROOT/app.server.$USER.properties ]; then
		TOMCAT_VERSION=$(grep -F app.server.tomcat.version= $GIT_ROOT/app.server.$USER.properties | cut -d'=' -f 2)
	fi

	if [ "" == "$TOMCAT_VERSION" ] && [ -f $GIT_ROOT/app.server.properties ]; then
		TOMCAT_VERSION=$(grep -F app.server.tomcat.version= $GIT_ROOT/app.server.properties | cut -d'=' -f 2)
	fi

	if [ "" != "$GIT_ROOT" ] && [ "" != "$TOMCAT_VERSION" ] && [ -d "$GIT_ROOT/util-taglib" ] && [ ! -f $LIFERAY_HOME/tomcat-$TOMCAT_VERSION/webapps/ROOT/WEB-INF/lib/util-taglib.jar ]; then
		echo "Deploying util-taglib.jar to $LIFERAY_HOME/tomcat-$TOMCAT_VERSION, because it may be needed in Gradle tasks"

		checksnapshots

		cd $GIT_ROOT/util-taglib
		ant deploy
		cd -
	fi
}

gw() {
	findgradle

	if [[ 0 -ne $? ]]; then
		return 1
	fi

	. $(dirname "${BASH_SOURCE[0]}")/appserverprops

	if [[ 0 -ne $? ]]; then
		return 1
	fi

	# Avoid running npm inside of gradle

	$(dirname ${BASH_SOURCE[0]})/nodejs/cachenpm

	# avoid using the CDN, because it's not reliable

	local GRADLE_ARGS="--stacktrace --no-daemon -Drepository.url=http://repository.liferay.com/nexus/content/groups/public"

	# run the gradlew binary, making sure to set GRADLE_OPTS if
	# it is not yet set

	local EXIT_CODE=0

	if [ -f $GRADLE_HOME/gradlew ]; then
		fixgradle

		echo $GRADLE_HOME/gradlew $GRADLE_ARGS $@
		$GRADLE_HOME/gradlew $GRADLE_ARGS $@

		EXIT_CODE=$?
	else
		gradle $GRADLE_ARGS $@

		EXIT_CODE=$?
	fi

	return $EXIT_CODE
}

javahome() {
	. $(dirname "${BASH_SOURCE[0]}")/javahome $@
}

setopts() {
	. $(dirname "${BASH_SOURCE[0]}")/setopts
}

if [ ! -f build.gradle ]; then
	echo "No build.gradle found"
	exit 0
fi

setopts

if [[ 8 -gt $JAVA_VERSION ]]; then
	javahome 8
	setopts
fi

if [ "" != "$GIT_ROOT" ]; then
	mkdir -p $GIT_ROOT/.redeploy

	cat /dev/null > $GIT_ROOT/.redeploy/gwchanges.txt
fi

gw $@