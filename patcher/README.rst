Installation
============

Make sure that you've followed the initial setup steps for this repository:

* `Initial Setup <../SETUP.rst>`__

Then, add this section to `.bash_aliases` (or the equivalent on whichever shell you're using) which calls the script.

.. code-block:: bash

	findbuild() {
		FILES_MIRROR=http://mirrors/files.liferay.com \
			${MCD_RD_CLONE_PATH}/patcher/findbuild $@
	}

	patcher() {
		${MCD_RD_CLONE_PATH}/patcher/patcher $@
	}

	subrepobp() {
		SUBREPO_ROOT=/path/to/subrepo/root \
			${MCD_RD_CLONE_PATH}/patcher/subrepobp $@
	}

Find Build for Hotfix
=====================

If you have a hotfix, you might want to be able to find the build corresponding to that hotfix, whether for purposes of checking it out locally using the automatically generated tag or simply to see what fixes it included. This script opens a web browser to the build in patcher portal.

* `findbuild <findbuild>`__

You can use it by specifying the hotfix number followed by the version of Liferay. For example, if you want to load hotfix 1 for 7010, you would use any of the following commands.

.. code-block:: bash

	findbuild 1 7010
	findbuild hotfix-1-7010
	findbuild liferay-hotfix-1-7010

Add New Fixes
=============

You might want to create a new fix inside of patcher portal. This script ensures that all the fix baselines used in patcher portal (or at least, the ones that I remember to update in an S3 bucket) are available out locally, double-checks to make sure that you haven't modified any files that would cause your fix to get rejected (such as ``packageinfo`` updates or ``bnd.bnd`` updates that modify a version), and opens your web browser to the fix creation page.

* `patcher <patcher>`__

It doesn't accept any parameters, so you simply call it.

.. code-block:: bash

	patcher

It uses the `patcher.json <patcher.json>`__ file stored in your clone of this Git repository, which is generated by visiting patcher portal with a Bookmarklet with the code described in `patcher.js <patcher.js>`__.

* `Bookmarklet Creator <http://mrcoles.com/bookmarklet/>`__

Right now, patcher has a defect where it doesnâ€™t know what to do with the URL parameter for the baseline ID the version is 2 (in other words, 7.0.x and later fixes). In order to work around this defect, you can use a Bookmarklet. Just paste the Javascript into the Bookmarklet Creator and add the result as a bookmarklet in your Bookmarks bar and click on it after Patcher Portal loads.

.. code-block:: javascript

	var selectName = '_1_WAR_osbpatcherportlet_patcherProjectVersionId';
	var select = AUI().one('#' + selectName);

	var re = new RegExp(selectName + '=(\\d+)');
	var match = re.exec(document.location.search);

	if (match) {
		var id = match[1];
		var option = select.one('option[value="' + id + '"]');

		if (option) {
			option.set('selected', true);
		}
	}

Backport Subrepository Changes
==============================

Before adding a fix to patcher portal, it's desirable to first backport the fix onto the ``ee-7.0.x`` branch so that you can cherry pick the commit into your main branch. While this is pretty easy for changes coming from the central repository using tools like `backport automator <https://github.com/jonathanmccann/backport-automator>`__, it's less easy for changes coming from subrepositories.

This script captures the commits within each subrepository where the log messages match a specific pattern, most likely an LPS ticket (``git log --grep``). It rewrites the patch files so that they can be applied to ``ee-7.0.x``, and as long as the portal source is currently at ``ee-7.0.x``, it then creates a new branch then attempts to apply the changes to ``ee-7.0.x`` using ``git am``.

* `subrepobp <subrepobp>`__

To use this script, run it from a folder that currently has ``ee-7.0.x`` checked out or a DE baseline tag checked out. Then, list all of the tickets that you wish to backport from the subrepository. This does not yet search for dependencies; it simply searches the logs for the specified tickets and brings them in order.

.. code-block:: bash

	subrepobp LPS-1 LPS-2 LPS-3 LPS-4
