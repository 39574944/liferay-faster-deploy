#!/bin/bash

buildopts() {
	if [ "" == "$ANT_OPTS" ]; then
		export ANT_OPTS='-Xms1g -Xmx1g'
	fi

	if [ "" == "$GRADLE_OPTS" ]; then
		export GRADLE_OPTS='-Xms3g -Xmx3g -Dorg.gradle.workers.max=1'
	fi
}

checkjava() {
	local MINIMUM_JAVA_VERSION=8

	if [ -f "$GIT_ROOT/build.properties" ]; then
		MINIMUM_JAVA_VERSION=$(grep javac.source "$GIT_ROOT/build.properties" | cut -d'=' -f 2 | cut -d'.' -f 2)
	fi

	JAVA_VERSION=$(java -version 2>&1 | head -1 | cut -d'"' -f 2 | cut -d'.' -f 2)

	if [[ $MINIMUM_JAVA_VERSION -gt $JAVA_VERSION ]]; then
		java -version

		echo
		echo "Please switch to JDK $MINIMUM_JAVA_VERSION or higher before building"

		return 1
	fi
}

gitroot() {
	GIT_ROOT=$PWD

	while [ ! -e "$GIT_ROOT/.git" ] && [ "/" != "$GIT_ROOT" ]; do
		GIT_ROOT=$(dirname $GIT_ROOT)
	done

	if [ ! -e "$GIT_ROOT/.git" ]; then
		GIT_ROOT=
		echo "Unable to find version control root"
		return 1
	fi
}

initfolder() {
	mkdir -p $GIT_ROOT/.redeploy
}

if [ "" == "$USER" ]; then
	USER=$USERNAME
fi

buildopts

if [ "" == "$GIT_ROOT" ]; then
	gitroot && initfolder && checkjava
fi