#!/bin/bash

gitcdb() {
	if [ "" == "$1" ]; then
		echo 'Please specify a Bundle-SymbolicName to locate'
		return 1
	fi

	# git ls-files wants a relative path, so let's generate it

	local ROOT_FOLDER=$(echo "$GIT_ROOT" | relpaths)

	# use git ls-files to find bnd.bnd files

	local SCRATCH_FILE=$GIT_ROOT/.redeploy/bndmatches.txt

	if [ -d "$ROOT_FOLDER/modules" ]; then
		git ls-files $ROOT_FOLDER/modules | grep -F '/bnd.bnd' > $GIT_ROOT/.redeploy/lsfiles.txt
	else
		git ls-files $ROOT_FOLDER | grep -F '/bnd.bnd' > $GIT_ROOT/.redeploy/lsfiles.txt
	fi

	# since the filter excludes the bnd.bnd in the current folder, check for it explicitly

	if [ -f bnd.bnd ]; then
		echo "bnd.bnd" >> $GIT_ROOT/.redeploy/lsfiles.txt
	fi

	# search the bnds for the symbolic name

	local needle=$(echo "$1" | sed 's/\./\\./g')

	cat $GIT_ROOT/.redeploy/lsfiles.txt | xargs grep -l "Bundle-SymbolicName: .*${needle}.*$" > "$SCRATCH_FILE"

	if [[ 0 -eq $(cat "$SCRATCH_FILE" | wc -l) ]]; then
		echo "Could not find Bundle-SymbolicName $1"
		return 1
	fi

	# at this point, we know we have at least a partial match
	# now to find out if there is an exact guess we can make

	local BND=$(cat "$SCRATCH_FILE")

	if [[ 1 -eq $(echo "$BND" | wc -l) ]]; then
		builtin cd $(dirname $BND)
		pwd
		return 0
	fi

	BND=$(cat "$SCRATCH_FILE" | xargs grep -l "Bundle-SymbolicName: ${needle}$")

	if [[ 1 -eq $(echo -n "$BND" | wc -l) ]]; then
		echo "$BND"
		builtin cd $(dirname $BND)
		pwd
		return 0
	fi

	BND=$(cat "$SCRATCH_FILE" | xargs grep -l "Bundle-SymbolicName: .*${needle}$")

	if [[ 1 -eq $(echo -n "$BND" | wc -l) ]]; then
		builtin cd $(dirname $BND)
		pwd
		return 0
	fi

	BND=$(cat "$SCRATCH_FILE" | xargs grep -l "Bundle-SymbolicName: ${needle}.*$")

	if [[ 1 -eq $(echo -n "$BND" | wc -l) ]]; then
		builtin cd $(dirname $BND)
		pwd
		return 0
	fi

	# no exact guesses possible, so report that it is ambiguous

	echo "$1 is ambiguous:"
	cat "$SCRATCH_FILE" | xargs grep -hF 'Bundle-SymbolicName:' | cut -d' ' -f 2
	return 1
}

relpaths() {
	python $(dirname ${BASH_SOURCE[0]})/../relpaths.py
}

. "$(dirname "${BASH_SOURCE[0]}")/../setopts"

if [ "" != "$GIT_ROOT" ]; then
	gitcdb $@
fi